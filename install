#!/usr/bin/env zsh
set -e


ROOT_PATH="$HOME/dotfiles"
MODULES_PATH="$ROOT_PATH/modules"


usage(){
cat <<EOF


NAME
    ./install - Install Nozomi's favourite mac setups.


USAGE:
    ./install [OPTIONS]


OPTIONS:
    -a,   --apps          ğŸ§ğŸ»â€â™€ï¸ Apps Setup
    -b,   --homebrew      ğŸº Homebrew Setup
    -c,   --code          ğŸ¦„ Clone Repositoris
    -d,   --drive         ğŸŒ Sync with google drive
    -e,   --environment   ğŸŒ Environment Setup(asdf)
    -h,   --help          ğŸ’¡ Print this usage
    -k,   --sshkey        ğŸ” Generate ssh key
    -l,   --symlink       ğŸ—‚ Symbolic link
    -m,   --macos         ğŸ’» MacOS Setup
    -u=*, --unlink=*      ğŸ‘‹ Unlinking Symbolic links...



EOF
}


pre_sudo(){
  # Ask for the administrator password upfront
  sudo -v
  # Temporarily increasing sudo's timeout until the process has finished
  while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &
}


# Homebrew
setup_homebrew(){
  echo "ğŸº Homebrew Setup"
  pre_sudo
  source "$ROOT_PATH/src/homebrew.zsh"
}


# MacOS
# Dependencis | Homebrew
setup_macos(){
  echo "ğŸ’» MacOS Setup"
  pre_sudo
  source "$ROOT_PATH/src/macos.zsh"
}


# Apps
# Dependencis | Homebrew | Link
setup_apps(){
  echo "ğŸ§ğŸ»â€â™€ï¸ Apps Setup"
  source "$ROOT_PATH/src/apps.zsh"
}


# Environment
# Dependencis | Homebrew
setup_environment(){
  echo "ğŸŒ Environment Setup(asdf)"
  source "$ROOT_PATH/src/env.zsh"
}


# Link
# Dependencis | Homebrew
link_modules(){
  echo "ğŸ—‚ Symbolic link"
  stow -vd "$MODULES_PATH" -t ~ $(ls $MODULES_PATH)
}


# Unlink
# Dependencis | Homebrew
unlink_modules(){
  echo "ğŸ‘‹ Unlinking Symbolic links..."
  stow -vD -d "$MODULES_PATH" -t ~ "$MODULES"
  exit
}


# Code
# Dependencis | Homebrew
setup_repositoris(){
  echo "ğŸ¦„ Clone Repositoris"
  source "$ROOT_PATH/src/code.zsh"
}


# SSHkey
# Dependencis | Homebrew
generate_sshkey(){
  echo "ğŸ” Generate ssh key"
  source "$ROOT_PATH/src/sshkey.zsh"
}


# Drive
# Dependencis | Homebrew, Mirror Google Drive files
sync_with_drive(){
  echo "ğŸŒ Sync with google drive"
  source "$ROOT_PATH/src/drive.zsh"
}



if [ ! $@ ]; then
  echo "ğŸ‘¨ğŸ»â€ğŸš€: Installing the best Mac setup!!"
  pre_sudo
  setup_homebrew
  setup_macos
fi
for i in "$@"; do
  case "$i" in
    -a|--apps)
      setup_apps
      shift ;;
    -b|--homebrew)
      setup_homebrew
      shift ;;
    -c|--code)
      setup_repositoris
      shift ;;
    -d|--drive )
      sync_with_drive
      shift ;;
    -e|--environment)
      setup_environment
      shift ;;
    -h|--help)
      usage
      shift ;;
    -k|--sshkey)
      generate_sshkey
      shift ;;
    -l|--symlink)
      link_modules
      shift ;;
    -m|--macos)
      setup_macos
      shift ;;
    -u=*|--unlink=*)
      MODULES="${i#*=}"
      unlink_modules
      shift ;;
    *)
      usage
      shift ;;
  esac
done
